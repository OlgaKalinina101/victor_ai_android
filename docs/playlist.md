–≠—Ç–æ—Ç —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–æ–µ–∫—Ç–∞ Victor AI

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π GNU Affero General Public License v3.0 (AGPL-3.0).

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏: https://www.gnu.org/licenses/agpl-3.0.html  
–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç: **[LICENSE.txt](../LICENSE.txt)** –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

Copyright ¬© 2026 Olga Kalinina

---

## –≠–∫—Ä–∞–Ω "–ü–ª–µ–π–ª–∏—Å—Ç" (Playlist)

> –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä —Å AI-–∞—Å—Å–∏—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–¥–±–æ—Ä–æ–º —Ç—Ä–µ–∫–æ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —ç–Ω–µ—Ä–≥–∏–∏/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –∏ offline –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

–ü–ª–µ–π–ª–∏—Å—Ç Victor AI ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Ç—Ä–µ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä —á–µ—Ä–µ–∑ AI, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **AI-–ø–æ–¥–±–æ—Ä —Ç—Ä–µ–∫–æ–≤** - "–í—ã–±–µ—Ä–∏ —Å–∞–º" —Å reasoning –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–í–æ–ª–Ω—ã (Waves)** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –ø–æ —ç–Ω–µ—Ä–≥–∏–∏/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ —Ç—Ä–µ–∫–æ–≤
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - —Ç–æ–ø —Ç—Ä–µ–∫–æ–≤, –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π
- **–ú–æ–º–µ–Ω—Ç—ã** - –∏—Å—Ç–æ—Ä–∏—è AI-–ø–æ–¥–±–æ—Ä–æ–≤ —Å reasoning
- **Offline –∫—ç—à** - –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- **MediaSession** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å lock screen –∏ bluetooth

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
–î–ª—è —Ä–∞–±–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –ë–î —Å —Ç—Ä–µ–∫–∞–º–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.  
üìñ [–ì–∞–π–¥ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –ë–î](https://github.com/OlgaKalinina101/victor_ai_backend/blob/main/docs/tools.md)

### API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

#### –¢—Ä–µ–∫–∏:
- **GET `/tracks`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (—ç–Ω–µ—Ä–≥–∏—è, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `offset` –∏ `limit`

- **GET `/tracks/stream/{track_id}`** - —Å—Ç—Ä–∏–º–∏–Ω–≥ —Ç—Ä–µ–∫–∞
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è:
- **GET `/tracks/stats`** - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π
  - `total_plays`, `top_tracks`, `top_energy`, `top_temperature`, `average_duration`

- **GET `/tracks/playlist_moments`** - –∏—Å—Ç–æ—Ä–∏—è AI-–ø–æ–¥–±–æ—Ä–æ–≤
  - –°–ø–∏—Å–æ–∫ –º–æ–º–µ–Ω—Ç–æ–≤ —Å reasoning (stage1, stage2, stage3) –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç—Ä–µ–∫–æ–º

#### –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä:
- **POST `/tracks/choose_for_me`** - AI –≤—ã–±–∏—Ä–∞–µ—Ç —Ç—Ä–µ–∫ —Å streaming reasoning
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SSE stream —Å –ª–æ–≥–∞–º–∏ –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  - –í –∫–æ–Ω—Ü–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫

- **POST `/tracks/run_playlist_wave`** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è "–≤–æ–ª–Ω—ã" —Ç—Ä–µ–∫–æ–≤
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `energy`, `temperature`
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
  - –¢—Ä–µ–∫–∏ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∏–∑ –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

#### –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:
- **POST `/tracks/update_track_description`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ç—Ä–µ–∫–∞
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `track_id`, `energy_description`, `temperature_description`

---

## üì∏ UI

<table>
  <tr>
    <td align="center"><img src="example/playlist_1.jpg" width="300" /><br><sub>–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–ª–µ–π–ª–∏—Å—Ç–∞</sub></td>
    <td align="center"><img src="example/playlist_2.gif" width="300" /><br><sub>Bottom sheet —Å —Ç—Ä–µ–∫–∞–º–∏</sub></td>
    <td align="center"><img src="example/playlist_3.gif" width="300" /><br><sub>–ò—Å—Ç–æ—Ä–∏—è –º–æ–º–µ–Ω—Ç–æ–≤</sub></td>
    <td align="center"><img src="example/playlist_4.gif" width="300" /><br><sub>AI –ø–æ–¥–±–æ—Ä "–í—ã–±–µ—Ä–∏ —Å–∞–º"</sub></td>
  </tr>
</table>

---

# üéµ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ–∞–π–ª–æ–≤)
4. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#-–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
5. [Streaming –ª–æ–≥–∏](#-streaming-–ª–æ–≥–∏)
6. [–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞](#-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è-–∏-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)
7. [–ê—É–¥–∏–æ –ø–ª–µ–µ—Ä](#-–∞—É–¥–∏–æ-–ø–ª–µ–µ—Ä)
8. [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#-–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)
9. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
10. [–û—Ç–ª–∞–¥–∫–∞](#-–æ—Ç–ª–∞–¥–∫–∞)
11. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#Ô∏è-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
12. [–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã](#-—Å–≤—è–∑–∞–Ω–Ω—ã–µ-–¥–æ–∫—É–º–µ–Ω—Ç—ã)
13. [–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è](#-–±—É–¥—É—â–∏–µ-—É–ª—É—á—à–µ–Ω–∏—è)

---

## üéØ –û–±–∑–æ—Ä

–ü–ª–µ–π–ª–∏—Å—Ç Victor AI ‚Äî —ç—Ç–æ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä —Å **AI-–∞—Å—Å–∏—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–¥–±–æ—Ä–æ–º —Ç—Ä–µ–∫–æ–≤**, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π **streaming –ª–æ–≥–æ–≤**, **—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —ç–Ω–µ—Ä–≥–∏–∏/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ** –∏ **offline –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º**.

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

- ‚úÖ **–ï–¥–∏–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI** —á–µ—Ä–µ–∑ `PlaylistUiState`
- ‚úÖ **Streaming –ª–æ–≥–∏** –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **–†–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** —á–µ—Ä–µ–∑ `combine()` flows
- ‚úÖ **UI –º–æ–¥–µ–ª—å** —Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (`TrackUiModel`)
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—Ä—É—Ç–∏–Ω—ã** (—Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å –ø–æ–∫–∞–∑–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ **MediaSession** –¥–ª—è lock screen / bluetooth
- ‚úÖ **Offline –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ç—Ä–µ–∫–æ–≤

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ï–¥–∏–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI

–í—Å—ë –∂–∏–≤—ë—Ç –≤ –æ–¥–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ:

```kotlin
data class PlaylistUiState(
    // üéµ –¢—Ä–µ–∫–∏ –∏ –ø–ª–µ–µ—Ä
    val tracks: List<TrackUiModel> = emptyList(),
    val currentPlayingTrackId: Int? = null,
    val isPlaying: Boolean = false,
    val currentPosition: Float = 0f,
    
    // üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    val stats: TrackStats? = null,
    
    // üîÑ –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    val isLoading: Boolean = false,
    val isWaveLoading: Boolean = false,
    
    // ‚ö†Ô∏è –û—à–∏–±–∫–∏
    val error: ErrorState? = null,
    
    // üîç –§–∏–ª—å—Ç—Ä—ã (–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã)
    val energyFilter: String? = null,
    val temperatureFilter: String? = null,
    val sortBy: String = "recent",
    val energyOptions: List<String> = emptyList(),
    val temperatureOptions: List<String> = emptyList(),
    
    // üéµ Streaming –ª–æ–≥–∏
    val streamingLog: String = ""
)
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
ui/playlist/
‚îú‚îÄ‚îÄ PlaylistScreen.kt              # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω —Å markdown —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
‚îú‚îÄ‚îÄ PlaylistSheet.kt               # Bottom sheet —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç—Ä–µ–∫–æ–≤
‚îú‚îÄ‚îÄ PlaylistViewModel.kt           # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚îú‚îÄ‚îÄ PlaylistUiState.kt            # –ú–æ–¥–µ–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (UiState, TrackUiModel, ErrorState)
‚îú‚îÄ‚îÄ AmbientStreamInline.kt        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è streaming –ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ PLAYLIST_ARCHITECTURE.md      # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ QUICK_REFERENCE.md            # –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
‚îÇ
‚îî‚îÄ‚îÄ components/
    ‚îú‚îÄ‚îÄ CurrentTrackPlayer.kt     # –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
    ‚îú‚îÄ‚îÄ TrackItem.kt              # –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–∞ (–æ–±—ã—á–Ω—ã–π)
    ‚îú‚îÄ‚îÄ TrackItemWithCheckbox.kt  # –≠–ª–µ–º–µ–Ω—Ç —Å —á–µ–∫–±–æ–∫—Å–æ–º (–¥–ª—è –≤—ã–±–æ—Ä–∞)
    ‚îú‚îÄ‚îÄ EditTrackSheet.kt         # Bottom sheet –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    ‚îî‚îÄ‚îÄ PlaylistUtils.kt          # –£—Ç–∏–ª–∏—Ç—ã (formatDuration, —Ü–≤–µ—Ç–∞)

data/network/
‚îú‚îÄ‚îÄ MusicApi.kt                   # API –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Retrofit
‚îú‚îÄ‚îÄ MusicApiImpl.kt              # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ streaming
‚îî‚îÄ‚îÄ Track, TrackStats, WaveResponse # DTOs

data/repository/
‚îî‚îÄ‚îÄ PlaylistRepository.kt         # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

logic/
‚îú‚îÄ‚îÄ AudioPlayer.kt               # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ ExoPlayer + MediaSession
‚îî‚îÄ‚îÄ MusicPlaybackService.kt     # Foreground Service –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User opens  ‚îÇ
‚îÇ PlaylistScreen ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ViewModel.init()‚îÇ
‚îÇ - loadTracks()  ‚îÇ ‚îÄ‚îÄ‚îê
‚îÇ - loadStats()   ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
                      ‚îÇ
                      ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ musicApi.getTracks() ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ _rawTracks.value ‚îÇ (List<Track> - DTO)
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ startUiStateUpdater()      ‚îÇ
    ‚îÇ combine(                   ‚îÇ
    ‚îÇ   _rawTracks,              ‚îÇ
    ‚îÇ   _trackCacheStates,       ‚îÇ
    ‚îÇ   _uiState                 ‚îÇ
    ‚îÇ ) { ... }                  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Track ‚Üí TrackUiModel  ‚îÇ (–ú–∞–ø–ø–∏–Ω–≥)
    ‚îÇ - formatDuration()    ‚îÇ
    ‚îÇ - getEnergyColor()    ‚îÇ
    ‚îÇ - getTemperatureColor() ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è       ‚îÇ
    ‚îÇ + –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ _uiState.update  ‚îÇ
    ‚îÇ { it.copy(       ‚îÇ
    ‚îÇ   tracks = ...   ‚îÇ
    ‚îÇ )}               ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ UI collectAsState‚îÇ
    ‚îÇ ‚Üí –†–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞

```
User clicks Play
      ‚îÇ
      ‚ñº
viewModel.playTrack(trackId)
      ‚îÇ
      ‚îú‚îÄ‚Üí –ù–∞–π—Ç–∏ Track –≤ _rawTracks
      ‚îú‚îÄ‚Üí audioPlayer.updateTrackMetadata()
      ‚îú‚îÄ‚Üí audioPlayer.playFromUrl(streamUrl)
      ‚îú‚îÄ‚Üí _uiState.update { copy(currentPlayingTrackId, isPlaying=true) }
      ‚îî‚îÄ‚Üí MusicPlaybackService.startPlayback() (Foreground Service)
            ‚îÇ
            ‚îî‚îÄ‚Üí MediaStyle notification —Å –∫–Ω–æ–ø–∫–∞–º–∏ play/pause/next/prev
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)

```kotlin
// ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
_uiState.collectLatest { state ->
    if (state.isPlaying) {
        while (isActive && _uiState.value.isPlaying) {
            delay(100)
            val position = audioPlayer.getCurrentPosition()
            _uiState.update { it.copy(currentPosition = position / 1000f) }
        }
    }
}
```

---

## üéµ Streaming –ª–æ–≥–∏

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç streaming:

```
User: "–í—ã–±–µ—Ä–∏ —Å–∞–º..."
      ‚îÇ
      ‚ñº
viewModel.runAssistantWaveStreaming(manual=true)
      ‚îÇ
      ‚ñº
musicApi.runPlaylistChainStreaming(accountId, "manual") { event ->
    ‚îÇ
    ‚îú‚îÄ‚Üí {"log": "üéµ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é..."}
    ‚îÇ   ‚îî‚îÄ‚Üí _uiState.update { copy(streamingLog = "üéµ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é...") }
    ‚îÇ   ‚îî‚îÄ‚Üí delay(—Ç–∏–ø–∏–Ω–≥ + —á—Ç–µ–Ω–∏–µ)  // –î–∞—ë–º –≤—Ä–µ–º—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    ‚îÇ
    ‚îú‚îÄ‚Üí {"log": "üé§ –≤—ã–±–∏—Ä–∞—é –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è..."}
    ‚îÇ   ‚îî‚îÄ‚Üí _uiState.update { copy(streamingLog = "üé§ –≤—ã–±–∏—Ä–∞—é...") }
    ‚îÇ   ‚îî‚îÄ‚Üí delay(—Ç–∏–ø–∏–Ω–≥ + —á—Ç–µ–Ω–∏–µ)
    ‚îÇ
    ‚îú‚îÄ‚Üí {"track": {"track_id": 123, ...}}
    ‚îÇ   ‚îî‚îÄ‚Üí playTrack(123)
    ‚îÇ
    ‚îî‚îÄ‚Üí {"done": true}
        ‚îî‚îÄ‚Üí delay(2000)
        ‚îî‚îÄ‚Üí _uiState.update { copy(streamingLog = "") }
}
```

### –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏ –≤ UI:

```kotlin
// PlaylistScreen.kt
LaunchedEffect(uiState.streamingLog) {
    if (uiState.streamingLog.isNotEmpty()) {
        showAmbientStream = true
        typedText = ""
        
        // –ü–µ—á–∞—Ç–∞–µ–º –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ
        uiState.streamingLog.forEachIndexed { index, _ ->
            delay(50) // 50–º—Å –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏
            typedText = uiState.streamingLog.take(index + 1)
        }
    } else {
        showAmbientStream = false
    }
}
```

### Timing –ª–æ–≥–æ–≤:

```kotlin
// ViewModel —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –∫–∞–∂–¥–æ–≥–æ –ª–æ–≥–∞:
val typingTime = (logText.length * 50L).coerceAtLeast(1000L)
val readingTime = 1500L
delay(typingTime + readingTime)
```

**–ü—Ä–∏–º–µ—Ä:**
- –õ–æ–≥ "üéµ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ..." (37 —Å–∏–º–≤–æ–ª–æ–≤)
- –í—Ä–µ–º—è –ø–µ—á–∞—Ç–∏: 37 √ó 50–º—Å = **1850–º—Å**
- –í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è: **1500–º—Å**
- **–ò—Ç–æ–≥–æ:** 3.35 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –ª–æ–≥–æ–º

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: Ngrok –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç streaming

**–°–∏–º–ø—Ç–æ–º:** –í—Å–µ –ª–æ–≥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–∏–º –±–ª–æ–∫–æ–º –≤ –∫–æ–Ω—Ü–µ, –∞ –Ω–µ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

**–ü—Ä–∏—á–∏–Ω–∞:** Ngrok (–¥–∞–∂–µ –ø–ª–∞—Ç–Ω—ã–π) –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç HTTP –æ—Ç–≤–µ—Ç—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –±—ã—Å—Ç—Ä–æ.

**–†–µ—à–µ–Ω–∏—è:**

1. **–ù–∞ –±—ç–∫–µ–Ω–¥–µ (FastAPI):**
```python
async def jsonlines_stream():
    async for item in builder.build_with_logs():
        line = json.dumps(item, ensure_ascii=False) + "\n"
        yield line
        await asyncio.sleep(0)  # üî• –î–∞—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å event loop
```

2. **–ù–∞ —Ñ—Ä–æ–Ω—Ç–µ:**
```kotlin
// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ª–æ–≥–∞–º–∏
delay(typingTime + readingTime)
```

3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ tunnels:**
    - `cloudflared` (Cloudflare Tunnel) ‚Äî –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ streaming
    - `localtunnel` ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
    - –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ VPN

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –§—Ä–æ–Ω—Ç –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –º–µ–∂–¥—É –ª–æ–≥–∞–º–∏.

---

## üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞

### –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã

–§–∏–ª—å—Ç—Ä—ã –∂–∏–≤—É—Ç **–¢–û–õ–¨–ö–û** –≤ `PlaylistUiState`:

```kotlin
// –§–∏–ª—å—Ç—Ä—ã –≤ ViewModel
data class PlaylistUiState(
    val energyFilter: String? = null,
    val temperatureFilter: String? = null,
    val sortBy: String = "recent"
)

// UI –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã:
viewModel.updateEnergyFilter("–í—ã—Å–æ–∫–∞—è")
```

### –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `combine()`:

```kotlin
combine(
    _rawTracks,           // –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
    _trackCacheStates,    // –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–µ—à–∞
    _uiState              // –¢–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
) { rawTracks, cacheStates, currentState ->
    
    // 1. –ú–∞–ø–ø–∏–Ω–≥ Track ‚Üí TrackUiModel
    val tracksWithCache = rawTracks.map { track ->
        track.toUiModel(cacheStates[track.id] ?: TrackCacheState.NOT_CACHED)
    }
    
    // 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    val filtered = tracksWithCache.filter { track ->
        (currentState.energyFilter == null || 
         track.energyDescription == currentState.energyFilter) &&
        (currentState.temperatureFilter == null || 
         track.temperatureDescription == currentState.temperatureFilter)
    }
    
    // 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    val sorted = when (currentState.sortBy) {
        "title" -> filtered.sortedBy { it.title }
        "artist" -> filtered.sortedBy { it.artist }
        "duration" -> filtered.sortedByDescending { it.duration }
        else -> filtered.sortedByDescending { it.id }
    }
    
    // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI state
    currentState.copy(tracks = sorted, ...)
    
}.collect { newState ->
    _uiState.value = newState
}
```

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ ‚Üí UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!

---

## üîä –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–µ–µ—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PlaylistViewModel      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - playTrack()            ‚îÇ
‚îÇ - pauseTrack()           ‚îÇ
‚îÇ - resumeTrack()          ‚îÇ
‚îÇ - seekTo()               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      AudioPlayer         ‚îÇ (logic/AudioPlayer.kt)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - ExoPlayer              ‚îÇ
‚îÇ - MediaSession           ‚îÇ
‚îÇ - WakeLock / WiFiLock    ‚îÇ
‚îÇ - Audio Focus            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îú‚îÄ‚Üí Callbacks:
        ‚îÇ   - onCompletion ‚Üí playNextTrack()
        ‚îÇ   - onPlayPause ‚Üí update _isPlaying
        ‚îÇ   - onNext ‚Üí playNextTrack()
        ‚îÇ   - onPrevious ‚Üí playPreviousTrack()
        ‚îÇ
        ‚îî‚îÄ‚Üí MediaSession callbacks:
            - onPlay / onPause / onNext / onPrevious / onSeekTo
```

### MediaSession –¥–ª—è lock screen

```kotlin
// AudioPlayer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç MediaSession
private fun initMediaSession() {
    mediaSession = MediaSessionCompat(context, "VictorAI_MediaSession").apply {
        setCallback(object : MediaSessionCompat.Callback() {
            override fun onPlay() { resume() }
            override fun onPause() { pause() }
            override fun onSkipToNext() { onNextCallback?.invoke() }
            override fun onSkipToPrevious() { onPreviousCallback?.invoke() }
            override fun onSeekTo(pos: Long) { seekTo(pos.toInt()) }
        })
        
        setFlags(
            FLAG_HANDLES_MEDIA_BUTTONS or
            FLAG_HANDLES_TRANSPORT_CONTROLS
        )
        
        isActive = true
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
fun updateTrackMetadata(title: String, artist: String, duration: Long) {
    mediaSession?.setMetadata(
        MediaMetadataCompat.Builder()
            .putString(METADATA_KEY_TITLE, title)
            .putString(METADATA_KEY_ARTIST, artist)
            .putLong(METADATA_KEY_DURATION, duration)
            .build()
    )
}
```

### Foreground Service

```kotlin
// PlaylistViewModel –∑–∞–ø—É—Å–∫–∞–µ—Ç service –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
MusicPlaybackService.startPlayback(
    context = applicationContext,
    trackTitle = track.title,
    trackArtist = track.artist,
    isPlaying = true,
    sessionToken = audioPlayer.getMediaSessionToken(),
    duration = track.duration.toLong(),
    position = 0
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å lock screen
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å bluetooth –≥–∞—Ä–Ω–∏—Ç—É—Ä—ã
- ‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
- ‚úÖ MediaStyle —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### ‚úÖ DO: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```kotlin
// ‚úÖ –ï–¥–∏–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
val uiState by viewModel.uiState.collectAsState()

// ‚úÖ UI –º–æ–¥–µ–ª—å —Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–æ–π
data class TrackUiModel(
    val formattedDuration: String,  // –ù–µ Float
    val artist: String,             // –ù–µ nullable
    val energyColor: Color          // –ì–æ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç
)

// ‚úÖ –õ–æ–≥–∏–∫–∞ –≤ ViewModel
viewModel.updateEnergyFilter("–í—ã—Å–æ–∫–∞—è")

// ‚úÖ UI –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è UI
var showDropdown by remember { mutableStateOf(false) }

// ‚úÖ Key –≤ LazyColumn
items(tracks, key = { it.id }) { track -> ... }

// ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
uiState.error?.let { error ->
    ErrorCard(error = error, onDismiss = { viewModel.clearError() })
}
```


## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–ö–æ—Ä—É—Ç–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**
    - Position updater: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `isPlaying = true`
    - Notification updater: —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π —á–µ—Ä–µ–∑ `combine()`

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ ViewModel**
    - –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π —Ä–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
    - –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `uiState.tracks`

3. **LazyColumn —Å key**
    - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

4. **UI –º–æ–¥–µ–ª—å —Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–æ–π**
    - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–µ
    - –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ

5. **remember –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π**
   ```kotlin
   val editingTrack = remember(editingTrackId, uiState.tracks) {
       editingTrackId?.let { id -> uiState.tracks.firstOrNull { it.id == id } }
   }
   ```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í–∫–ª—é—á–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:

```bash
# –§–∏–ª—å—Ç—Ä –¥–ª—è –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –ø–ª–µ–π–ª–∏—Å—Ç–∞
adb logcat -s PlaylistViewModel:D MusicApiImpl:D AudioPlayer:D

# –ò–ª–∏ –≤ Android Studio Logcat:
tag:PlaylistViewModel OR tag:MusicApiImpl OR tag:AudioPlayer
```

### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è:

- `üéµ Starting streaming wave` - –ù–∞—á–∞–ª–æ streaming –∑–∞–ø—Ä–æ—Å–∞
- `üì° Response received` - –ü–æ–ª—É—á–µ–Ω HTTP –æ—Ç–≤–µ—Ç
- `üìù Stream log` - –ü–æ–ª—É—á–µ–Ω –ª–æ–≥ –∏–∑ stream
- `üéß Stream received track` - –ü–æ–ª—É—á–µ–Ω —Ç—Ä–µ–∫
- `‚úÖ Stream completed` - Stream –∑–∞–≤–µ—Ä—à—ë–Ω
- `‚ùå Error` - –û—à–∏–±–∫–∞

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### UI
- **Jetpack Compose** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI toolkit
- **Material 3** - –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–∞
- **LazyColumn** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤
- **BottomSheet** - –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Ç—Ä–µ–∫–æ–≤ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **MVVM** - Model-View-ViewModel –ø–∞—Ç—Ç–µ—Ä–Ω
- **Hilt** - Dependency Injection
- **Kotlin Coroutines** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- **StateFlow** - reactive state management
- **combine()** - —Ä–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ê—É–¥–∏–æ
- **ExoPlayer** - –º–æ—â–Ω—ã–π –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä –æ—Ç Google
- **MediaSession** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏
- **AudioManager** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ audio focus
- **WakeLock / WiFiLock** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞—Å—ã–ø–∞–Ω–∏—è –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏

### –°–µ—Ç—å
- **Retrofit + Moshi** - HTTP –∫–ª–∏–µ–Ω—Ç –∏ JSON
- **SSE (Server-Sent Events)** - —Å—Ç—Ä–∏–º–∏–Ω–≥ reasoning –æ—Ç AI
- **OkHttp** - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π HTTP –∫–ª–∏–µ–Ω—Ç

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **UI –º–æ–¥–µ–ª—å (TrackUiModel)** - –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- **remember** - –º–µ–º–æ–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- **key** –≤ LazyColumn - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è
- **Conditional coroutines** - —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### –°–µ—Ä–≤–∏—Å—ã
- **Foreground Service** - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
- **MediaStyle Notification** - —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [places.md](places.md) - –≠–∫—Ä–∞–Ω "–ú–µ—Å—Ç–∞" —Å –∏–≥—Ä–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π
- [calendar.md](calendar.md) - –≠–∫—Ä–∞–Ω "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
- [chat.md](chat.md) - –≠–∫—Ä–∞–Ω "–ß–∞—Ç"
- [README.md](README.md) - –û–±–∑–æ—Ä –≤—Å–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üöÄ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
- [ ] –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
- [ ] Lyrics display (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã)
- [ ] –≠–∫–≤–∞–ª–∞–π–∑–µ—Ä —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏
- [ ] Sleep timer (—Ç–∞–π–º–µ—Ä —Å–Ω–∞)
- [ ] –ö—Ä–æ—Å—Å—Ñ–µ–π–¥ –º–µ–∂–¥—É —Ç—Ä–µ–∫–∞–º–∏
- [ ] –°–∫—Ä–æ–±–±–ª–∏–Ω–≥ –≤ Last.fm / ListenBrainz
- [ ] –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ (waveform)
- [ ] –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–µ–ª–∏—Ç—å—Å—è —Ç—Ä–µ–∫–∞–º–∏)
- [ ] –£–º–Ω—ã–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏





